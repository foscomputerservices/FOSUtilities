# Getting Started With ViewModel and ViewModelRequest

Simple and strongly-type client<->server communication.

## Overview

``ViewModel`` is a protocol that describes a *localized* unit of data that is communicated from the server to the client.  The contained data can be anything that is necessary to parameterize a view to be presented to the user.  For example, localized strings, images (both localized and static), database record information, etc.

``ViewModelRequest`` is a ``ServerRequest`` that is specific to ``ViewModel``s, which provides for the ability to request a ``ViewModel`` from the server.

## Walkthrough Example

### ViewModels

Here is an example of a ``ViewModel`` that provides a page title and some welcome text that can be displayed on the landing page of a website.

```swift
public struct LandingPageViewModel: RequestableViewModel {
    public typealias Request = LandingPageRequest

    @LocalizedString public var pageTitle
    @LocalizedString public var welcomeText

    public var vmId = ViewModelId()

    public init() {}

    static func stub() -> Self {
        .init()
    }
}
```

The model contains two strings that will be localized by the server before they are sent to the client.  It also contains a *vmId* that uniquely identifies this ``ViewModel`` instance.  In this case each instance generated by the server will have a unique id.  However, the id can also be tied to data the generated the ``ViewModel``, such as a database record id.  This id can be used by SwiftUI views when the view's identity is important ([SwiftUI](https://developer.apple.com/documentation/swiftui/view/id(_:)), [Hacking With Swift](https://www.hackingwithswift.com/books/ios-swiftui/working-with-identifiable-items-in-swiftui)).  This id prides the basis for the ``ViewModel`` to conform to [Identifiable](https://developer.apple.com/documentation/swift/identifiable), which is provided automatically.

**LandingPageViewModel** conforms to the ``RequestableViewModel`` protocol as opposed to the base ``ViewModel`` protocol to indicate that it can be requested from the web service via a **LandingPageRequest** instance.

### SwiftUI View

Now that a ``ViewModel`` is available, a SwiftUI view can be written using that model.

```
struct LandingPageView: ViewModelView {
    let viewModel: LandingPageViewModel

    var body: some View {
        VStack {
            Text(viewModel.pageTitle)
                .font(.headline)
                .padding(.bottom, 30)

            Text(viewModel.welcomeText)
        }
        .padding()
    }
}

#Preview {
    LandingPageView(
        viewModel: .stub()
    )
}
```

SwiftUI views that are based on ``ViewModel``s should inherit from ``ViewModelView`` as opposed to [View](https://developer.apple.com/documentation/swiftui/view) directly.  This will provide support for requesting the view model from the server in the view that hosts this view.

We can also easily preview our view by using the **Stubbable** protocol to give a stub implementation of our ``ViewModel``.

### ViewRequests

#### Specification

The client app will need to retrieve the ``ViewModel`` from the server.  In order to accomplish this, a ``ViewModelRequest`` needs to be written to allow the client application to request the ``ViewModel`` from the server.

```swift
public final class LandingPageRequest: ViewModelRequest {
    public typealias Query = EmptyQuery
    public let responseBody: LandingPageViewModel?

    public init(query: FOSMVVM.EmptyQuery? = nil, fragment: FOSMVVM.EmptyFragment? = nil, requestBody: FOSMVVM.EmptyBody? = nil, responseBody: LandingPageViewModel? = nil) {
        self.responseBody = responseBody
    }
}
```

In this simplified example, no query is communicated to the server as the landing page is unique on its own.  The only item that is specified is that of the **responseBody**, which will be the ``ViewModel`` returned by the server.  (The ``ViewModel`` will be constructed via ``ViewModelFactory``.)

#### SwiftUI Usage

To request the ``ViewModel`` we add the view to a view that hosts the ``ViewModel``.

```swift
struct HostView: View {
    @State var viewModel: LandingPageViewModel?

    var body: some View {
        LandingPageView.bind(
            viewModel: $viewModel
        )
    }
}
```

Our ``ViewModel`` is now hosted in **HostView** and the model will automatically be requested when **HostView** requires it.

### Creating ViewModel Instances

The server is responsible for creating instances of the ``ViewModel``s.  This is done by conforming the ``ViewModel`` implementation to ``ViewModelFactory``.

> NOTE: Since this example is a Vapor server, the implementation uses a Vapor-specific ``ViewModelFactory``,
> ``VaporViewModelFactory``, which provides a standard *Context* with Vapor-specific information.

```swift
import FOSFoundation
import FOSMVVM
import Foundation
import Vapor
import ViewModels

extension LandingPageViewModel: VaporViewModelFactory {
    public typealias VMRequest = LandingPageRequest

    public static func model(_ req: Vapor.Request, vmRequest: VaporModelFactoryContext<VMRequest>)) async throws -> Self {
        .init()
    }
}
```

In this example there was no work to do to create an instance of **LandingPageViewModel**.  However, the ``ViewModelFactory/model(_:vmRequest:)`` implementation may contain any code that is necessary to initialize the instance.  The [Vapor Request](https://docs.vapor.codes/advanced/request/) is provided, so any Vapor service can be used including [Files](https://docs.vapor.codes/advanced/files/), [Fluent](https://docs.vapor.codes/advanced/queues/), [Redis](https://docs.vapor.codes/advanced/queues/), [Queues](https://docs.vapor.codes/advanced/queues/), etc., to configure a ``ViewModel`` instance.

Any ``Localizable`` properties in the ``ViewModel`` will automatically be localized to the [Locale](https://developer.apple.com/documentation/foundation/locale) of the client application.

### Vapor Routing

To enable the [Vapor](https://docs.vapor.codes) web service to provide ``RequestableViewModel``s, they need to be registered in the web server's [routing](https://docs.vapor.codes/basics/routing/).  This is generally added to the server's *routes.swift* file.

```swift
import FOSFoundation
import FOSMVVM
import Vapor
import ViewModels

func routes(_ app: Application) throws {
    try app.routes.register(model: LandingPageViewModel.self)
}
```
